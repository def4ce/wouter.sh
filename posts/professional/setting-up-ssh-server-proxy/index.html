<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="ie=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="author" content="">
<meta name="description" content="Recently I setup an SSH server at home. This allows me, besides the obvious, to create an SSH tunnel to encrypt my connections and circumvent restrictions. This is particularly useful on public Wi-Fi networks. These networks may block certain services and other people using the network might be less friendly.
Installing Your Linux server most likely already has openssh-server installed. If it hasn&amp;rsquo;t, installing SSH server is easy. Because I use CentOS the examples will reflect that." />
<meta name="keywords" content=", linux, ssh" />
<meta name="robots" content="noodp" />
<meta name="theme-color" content="" />
<link rel="canonical" href="https://wouters.sh/posts/professional/setting-up-ssh-server-proxy/" />


    <title>
        
            Setting up an SSH server as a proxy :: Wouter in &#39;t Veld  — Cloud Engineer @ KNMI. Father of Sid and Fay. Partner of Donna.
        
    </title>



<link href="https://cdnjs.cloudflare.com/ajax/libs/flag-icon-css/3.5.0/css/flag-icon.min.css" rel="stylesheet"
    type="text/css">



<link rel="stylesheet" href="/main.17863a81d979b637a02cd7632a4d86e9d80563ef460fd6af1a56962efcaa066b.css">



    <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
    <link rel="manifest" href="/site.webmanifest">
    <link rel="mask-icon" href="/safari-pinned-tab.svg" color="">
    <link rel="shortcut icon" href="/favicon.ico">
    <meta name="msapplication-TileColor" content="">
    <meta name="theme-color" content="">



<meta itemprop="name" content="Setting up an SSH server as a proxy">
<meta itemprop="description" content="Recently I setup an SSH server at home. This allows me, besides the obvious, to create an SSH tunnel to encrypt my connections and circumvent restrictions. This is particularly useful on public Wi-Fi networks. These networks may block certain services and other people using the network might be less friendly.
Installing Your Linux server most likely already has openssh-server installed. If it hasn&rsquo;t, installing SSH server is easy. Because I use CentOS the examples will reflect that."><meta itemprop="datePublished" content="2019-07-09T00:00:00+00:00" />
<meta itemprop="dateModified" content="2019-07-09T00:00:00+00:00" />
<meta itemprop="wordCount" content="1182"><meta itemprop="image" content="https://wouters.sh"/>
<meta itemprop="keywords" content="linux,ssh," />
<meta name="twitter:card" content="summary_large_image"/>
<meta name="twitter:image" content="https://wouters.sh"/>

<meta name="twitter:title" content="Setting up an SSH server as a proxy"/>
<meta name="twitter:description" content="Recently I setup an SSH server at home. This allows me, besides the obvious, to create an SSH tunnel to encrypt my connections and circumvent restrictions. This is particularly useful on public Wi-Fi networks. These networks may block certain services and other people using the network might be less friendly.
Installing Your Linux server most likely already has openssh-server installed. If it hasn&rsquo;t, installing SSH server is easy. Because I use CentOS the examples will reflect that."/>








    <meta property="article:published_time" content="2019-07-09 00:00:00 &#43;0000 UTC" />










    </head>

    
        <body>
    
    
        <div class="container">
            <header class="header">
    <span class="header__inner">
        <a href="/" style="text-decoration: none;">
    <div class="logo">
        
            <span class="logo__mark">#</span>
            <span class="logo__text">./wouter.sh</span>
            <span class="logo__cursor" style=
                  "
                   
                   ">
            </span>
        
    </div>
</a>


        <span class="header__right">
            
                <nav class="menu">
    <ul class="menu__inner"><li><a href="/resume/">Resume</a></li>
    </ul>
</nav>

                <span class="menu-trigger">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
                        <path d="M0 0h24v24H0z" fill="none"/>
                        <path d="M3 18h18v-2H3v2zm0-5h18v-2H3v2zm0-7v2h18V6H3z"/>
                    </svg>
                </span>
            
                <span class="theme-toggle not-selectable"><svg class="theme-toggler" width="24" height="24" viewBox="0 0 48 48" fill="none" xmlns="http://www.w3.org/2000/svg">
   <path d="M22 41C32.4934 41 41 32.4934 41 22C41 11.5066 32.4934 3 22
   3C11.5066 3 3 11.5066 3 22C3 32.4934 11.5066 41 22 41ZM7 22C7
   13.7157 13.7157 7 22 7V37C13.7157 37 7 30.2843 7 22Z"/>
 </svg></span>
        </span>
    </span>
</header>


            <div class="content">
                
  <main class="post">

    <div class="post-info">
      <p>
        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-clock">
          <circle cx="12" cy="12" r="10"></circle>
          <polyline points="12 6 12 12 16 14"></polyline>
        </svg>
        6 minutes

        
      </p>
    </div>

    <article>
      <h1 class="post-title">
        <a href="https://wouters.sh/posts/professional/setting-up-ssh-server-proxy/">Setting up an SSH server as a proxy</a>
      </h1>

      

      

      

      <div class="post-content">
        <p>Recently I setup an SSH server at home. This allows me, besides the obvious, to create an SSH tunnel to encrypt my connections and circumvent restrictions. This is particularly useful on public Wi-Fi networks. These networks may block certain services and other people using the network might be <a href="http://lifehacker.com/5906233/do-i-really-need-to-be-that-worried-about-security-when-im-using-public-wi-fi" target="_blank">less</a>
 friendly.</p>
<h3 id="installing">Installing</h3>
<p>Your Linux server most likely already has openssh-server installed. If it hasn&rsquo;t,
installing SSH server is easy. Because I use CentOS the examples will reflect that.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">$ sudo yum -y install openssh-server
</code></pre></div><p>Start the sshd service:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">$ sudo systemctl start sshd
</code></pre></div><p>Making sure it starts when the machine boots</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">$ sudo systemctl enable sshd
Created symlink from /etc/systemd/system/multi-user.target.wants/sshd.service to /usr/lib/systemd/system/sshd.service.
</code></pre></div><p>Verifying the above:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">$ systemctl status sshd
● sshd.service - OpenSSH server daemon
   Loaded: loaded <span style="color:#f92672">(</span>/usr/lib/systemd/system/sshd.service; enabled; vendor preset: enabled<span style="color:#f92672">)</span>
   Active: active <span style="color:#f92672">(</span>running<span style="color:#f92672">)</span> since za 2017-09-09 18:18:35 UTC; 4s ago
     Docs: man:sshd<span style="color:#f92672">(</span>8<span style="color:#f92672">)</span>
           man:sshd_config<span style="color:#f92672">(</span>5<span style="color:#f92672">)</span>
 Main PID: <span style="color:#ae81ff">2413</span> <span style="color:#f92672">(</span>sshd<span style="color:#f92672">)</span>
   CGroup: /system.slice/sshd.service
           └─2413 /usr/sbin/sshd -D -u0

sep <span style="color:#ae81ff">09</span> 18:18:35 localhost.localdomain systemd<span style="color:#f92672">[</span>1<span style="color:#f92672">]</span>: Starting OpenSSH server daemon...
sep <span style="color:#ae81ff">09</span> 18:18:35 localhost.localdomain sshd<span style="color:#f92672">[</span>2413<span style="color:#f92672">]</span>: Server listening on 0.0.0.0 port 22.
sep <span style="color:#ae81ff">09</span> 18:18:35 localhost.localdomain sshd<span style="color:#f92672">[</span>2413<span style="color:#f92672">]</span>: Server listening on :: port 22.
sep <span style="color:#ae81ff">09</span> 18:18:35 localhost.localdomain systemd<span style="color:#f92672">[</span>1<span style="color:#f92672">]</span>: Started OpenSSH server daemon.
</code></pre></div><p>That&rsquo;s it. As a note, if you previously setup firewall rules to block incoming connections make sure to allow incoming traffic on port 22. I will post the iptables rules that I use in a moment.</p>
<h3 id="configure-sshd">Configure sshd</h3>
<p>Before editing <code>/etc/ssh/sshd_config</code> we need to generate an SSH key. Github has a good <a href="https://help.github.com/articles/generating-a-new-ssh-key-and-adding-it-to-the-ssh-agent/" target="_blank">tutorial</a>
 on this. Follow it to setup your SSH key. Use a different key for every machine that is going to connect to your SSH service. Once setup you can copy the key to the server with:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">$ ssh-copy-id wouter@server
</code></pre></div><p>Replace <code>server</code> with the hostname or ipadress of your ssh server and <code>user</code> with your user. You will be prompted to login with your password before the key gets copied. When the process is finished try logging in again to verify if it&rsquo;s working. Please refer to the Github <a href="https://help.github.com/articles/generating-a-new-ssh-key-and-adding-it-to-the-ssh-agent/" target="_blank">tutorial</a>
 if you run in to problems.</p>
<p>There are some configuration settings you can apply that harden your ssh service. Use your favourite editor to edit <code>/etc/ssh/sshd_config</code>, I use vi.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">$ sudo vi /etc/ssh/sshd_config
</code></pre></div><p>Add, edit or uncomment</p>
<pre tabindex="0"><code>PubkeyAuthentication yes
PasswordAuthentication no
ChallengeResponseAuthentication no
AllowTcpForwarding yes
</code></pre><p>This will <em>disable</em> password authentication, one-way-authentication and <em>enables</em> public key authentication and traffic forwarding. Keys are easily managed, unsniffable and uncrackable. The same can&rsquo;t be said about passwords.</p>
<p>The next one is up for discussion, allowing root access. Personally I disallow it, but <code>PermitRootLogin without-password</code> is a safe setting. This means <code>root</code> can only login with public key authentication. As mentioned, I&rsquo;ve set it to <code>PermitRootLogin no</code></p>
<p>Another good practice is to use a non-standard port for your ssh service. I haven&rsquo;t done it but this will significantly reduce the amount login tries from scriptkiddies. When choosing a port, have a look at what services <a href="https://nmap.org/" target="_blank">nmap</a>
 scans for on a default port scan.
To change to another port edit <code>/etc/ssh/sshd_config</code>:</p>
<pre tabindex="0"><code>Port 12345
</code></pre><p>Save your changes and verify the SSH configuration</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">$ sudo sshd -t
</code></pre></div><p>This should return no errors. When it doesn&rsquo;t you can restart the SSH daemon</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">$ sudo systemctl restart sshd
</code></pre></div><p>The new configuration is now active.</p>
<h3 id="setting-up-iptables">Setting up iptables</h3>
<p>Since I run my ssh service on the default port I am a target for <a href="https://en.wikipedia.org/wiki/Script_kiddie" target="_blank">scriptkiddies</a>
 trying to gain access to my machine. And since I want to tunnel my traffic when on public Wi-Fi I can&rsquo;t scope the access down to a few IP&rsquo;s.</p>
<p>CentOS comes with <code>firwalld</code>. I don&rsquo;t like <code>firewalld</code> so I disable it.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">$ sudo systemctl stop firewalld
$ sudo systemctl disable firewalld
Removed symlink /etc/systemd/system/dbus-org.fedoraproject.FirewallD1.service.
Removed symlink /etc/systemd/system/basic.target.wants/firewalld.service.
$ sudo systemctl mask firewalld
Created symlink from /etc/systemd/system/firewalld.service to /dev/null.
</code></pre></div><p>Disabling the service deletes the symlink, so the unit file itself is not affected, but the service is not loaded at the next boot, when systemd reads /etc/systemd/system.</p>
<p>However, a disabled service can be loaded, and will be started if a service that depends on it is started; enable and disable only configure auto-start behaviour for units, and the state is easily overridden.</p>
<p>A masked service is one whose unit file is a symlink to /dev/null. This makes it &ldquo;impossible&rdquo; to load the service, even if it is required by another, enabled service.</p>
<p>When you mask a service, a symlink is created from /etc/systemd/system to /dev/null, leaving the original unit file elsewhere untouched. When you unmask a service the symlink is deleted.</p>
<p>With <code>firewalld</code> out of the way, I can apply my iptables script to setup the firewall.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#75715e">#!/bin/bash
</span><span style="color:#75715e"></span>iptables -F                     <span style="color:#75715e"># flush rules</span>
iptables -X                     <span style="color:#75715e"># delete user added chains</span>
iptables -P FORWARD DROP        <span style="color:#75715e"># drop forwarding</span>
iptables -P INPUT DROP          <span style="color:#75715e"># drop incoming</span>
iptables -P OUTPUT ACCEPT       <span style="color:#75715e"># allow outgoing</span>

<span style="color:#75715e"># define custom chains</span>
iptables -N ssh_init
iptables -N ssh_throttle

iptables -A INPUT -m conntrack --ctstate RELATED,ESTABLISHED -j ACCEPT <span style="color:#75715e"># accept previously allowed traffic</span>
iptables -A INPUT -m conntrack --ctstate INVALID -j DROP <span style="color:#75715e"># invalid packets get dropped</span>
iptables -A INPUT -i lo -j ACCEPT <span style="color:#75715e"># allow all traffic on the loopback interface</span>

<span style="color:#75715e"># ssh init</span>
iptables -A INPUT -s 0/0 -p tcp --dport <span style="color:#ae81ff">22</span> --syn -j ssh_init
iptables -A ssh_init -m recent --name ssh_input_trap --rcheck --seconds <span style="color:#ae81ff">60</span> --hitcount <span style="color:#ae81ff">3</span> --rttl -j DROP
iptables -A ssh_init -m recent --name ssh_input_trap --set -j RETURN

<span style="color:#75715e"># ssh throttle</span>
iptables -A INPUT -s 0/0 -p tcp --dport <span style="color:#ae81ff">22</span> --syn -j ssh_throttle
iptables -A ssh_throttle -m connlimit --connlimit-above <span style="color:#ae81ff">3</span> -j DROP
iptables -A ssh_throttle -m limit --limit 3/m --limit-burst <span style="color:#ae81ff">1</span> -j ACCEPT

</code></pre></div><p>To make the rules persistent you need the <code>iptables-services</code> package since we disabled <code>firewalld</code>.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">$ yum -y install iptables-services
</code></pre></div><p>After installation you can run</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">$ sudo service iptables save
</code></pre></div><blockquote>
<p>note: If you run <code>docker</code> restart the docker service first before saving the rules. This will recreate the docker iptables rules</p>
</blockquote>
<p>These rules set the policy to drop all incoming packets except for the SYN packet on port 22. A SYN starts a connection, you&rsquo;ll usually only see it when the connection&rsquo;s being established. When someone sends three SYN packets in a minute, they get dropped. When they make more than three connections in a minute, they will get dropped. When the SYN is accepted a connection is established and the traffic will be allowed.</p>
<p>With these rules in place we can start using our SSH service.</p>
<h3 id="setting-up-an-ssh-tunnel">Setting up an SSH tunnel</h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">$ ssh -D <span style="color:#ae81ff">3000</span> -f -C -q -N wouter@miles
</code></pre></div><p>Let see what this command does.<br>
<code>-D 3000</code> This allocates a socket to listen on port 3000.<br>
<code>-f</code> Requests ssh to go to background just before command execution. <br>
<code>-C</code> Requests compression of all data.<br>
<code>-q</code> Quiet mode.<br>
<code>-N</code> Do not execute a remote command.<br>
<code>wouter@miles</code> user and the server.</p>
<p>With the tunnel up and running you need configure your browser to use it. In <code>Firefox</code> go to <code>preferences &gt; advanced &gt; network</code> and tick <code>manual proxy configuration</code>. Next set the <code>SOCKS Host</code> to <code>localhost</code> and <code>port</code> to <code>3000</code>. Also tick the <code>proxy dns when using socks5</code> box. <code>Firefox</code> is now ready to use the tunnel.</p>

      </div>
    </article>

    <hr />

    <div class="post-info">
      
    <p>
        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-tag meta-icon"><path d="M20.59 13.41l-7.17 7.17a2 2 0 0 1-2.83 0L2 12V2h10l8.59 8.59a2 2 0 0 1 0 2.82z"></path><line x1="7" y1="7" x2="7" y2="7"></line></svg>

        <span class="tag"><a href="https://wouters.sh/tags/linux/">linux</a></span>
        <span class="tag"><a href="https://wouters.sh/tags/ssh/">ssh</a></span>
        
    </p>

      

      <p>
        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-file-text">
          <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
          <polyline points="14 2 14 8 20 8"></polyline>
          <line x1="16" y1="13" x2="8" y2="13"></line>
          <line x1="16" y1="17" x2="8" y2="17"></line>
          <polyline points="10 9 9 9 8 9"></polyline>
        </svg>
        1182 Words
      </p>

      <p>
        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-calendar">
          <rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect>
          <line x1="16" y1="2" x2="16" y2="6"></line>
          <line x1="8" y1="2" x2="8" y2="6"></line>
          <line x1="3" y1="10" x2="21" y2="10"></line>
        </svg>
        
          2019-07-09 02:00 &#43;0200
        

         
          
        
      </p>
    </div>

    
    <div class="pagination">
        <div class="pagination__title">
            <span class="pagination__title-h">Read other posts</span>
            <hr />
        </div>

        <div class="pagination__buttons">
            
            <span class="button previous">
                <a href="https://wouters.sh/posts/professional/aws-disable-ssh/">
                    <span class="button__icon">←</span>
                    <span class="button__text">Disable SSH on your EC2 instances</span>
                </a>
            </span>
            

            
        </div>
    </div>


    

    

  </main>

            </div>

            
                <footer class="footer">
    
    
    <div class="footer__inner">
        <div class="footer__content">
            <span>Powered by ☁️</span>
        </div>
    </div>
    
</footer>

            
        </div>

        



<script type="text/javascript" src="/bundle.min.599099f1f14b78b657d524b28e10e0c5098e7cd46e9c7aed73d577068a276c3ff1bb234cbf29cb313333e83cf411727b43157c91ce5b809e2ffc81664614608e.js" integrity="sha512-WZCZ8fFLeLZX1SSyjhDgxQmOfNRunHrtc9V3BoonbD/xuyNMvynLMTMz6Dz0EXJ7QxV8kc5bgJ4v/IFmRhRgjg=="></script>



    </body>
</html>
